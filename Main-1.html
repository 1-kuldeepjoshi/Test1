<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JPG to PDF Converter</title>
    <!-- External libraries -->
    <script src="https://unpkg.com/pdf-lib@1.4.0"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <style>
      /* General styling */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      .taskbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 2rem;
        background-color: #f5f5f5;
        border-bottom: 1px solid #e0e0e0;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .logo img {
        width: 160px;
        height: 60px;
      }
      .logo-text {
        font-size: 1rem;
        font-weight: bold;
        color: #2c3e50;
      }
      .page-heading {
        text-align: center;
        font-size: 2rem;
        margin: 1rem 0;
        color: #2c3e50;
      }
      .buttons-container {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        background-color: #fff;
        border-bottom: 1px solid #d3d3d3;
      }
      #convertBtn,
      #downloadBtn {
        border: none;
        outline: none;
        background: rgb(89, 150, 248);
        color: white;
        border-radius: 0.2rem;
        padding: 0.5rem 1rem;
        font-size: 1.2rem;
        cursor: pointer;
      }
      #downloadBtn {
        display: none;
      }
      .upload-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
        margin: 1rem auto 1rem;
        max-width: 25rem;
        border: 2px solid blue;
        border-radius: 10px;
      }
      .description-container {
        text-align: center;
        padding: 1rem;
        background-color: #f1f1f1;
        border-radius: 8px;
        margin: 0 auto 2rem;
      }
      .inp-container {
        cursor: pointer;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 20rem;
        width: 20rem;
        border: 1px dashed rgb(195, 193, 193);
        border-radius: 50%;
        margin: auto;
      }
      #upload-file {
        opacity: 0;
        position: absolute;
        cursor: pointer;
        height: 100%;
        width: 100%;
      }
      .img-icon {
        color: rgba(128, 144, 238, 0.596);
        font-size: 3rem;
        margin-bottom: 0.5rem;
      }
      h4.drop {
        font-size: 1rem;
        color: rgb(108, 107, 175);
        margin: 0;
      }
      #custom-file {
        color: rgb(96, 102, 155);
        position: relative;
        top: 0.5rem;
        padding: 0.5rem 0.8rem;
        font-size: 1.1rem;
        border-radius: 0.2rem;
        font-weight: 600;
      }
      .uploaded-images-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 20px;
        padding: 1rem;
        background-color: lightgray;
        border-radius: 5px;
        margin-top: 2rem;
        min-height: 200px;
      }
      .image-container {
        background-color: #000;
        padding: 5px;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 5px;
        min-height: 200px;
      }
      .uploaded-image {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 5px;
        box-shadow: rgba(17, 17, 26, 0.1) 0px 1px 0px,
          rgba(17, 17, 26, 0.1) 0px 8px 24px;
        cursor: grab;
        overflow: hidden;
      }
      .uploaded-image img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 5px;
        transition: transform 0.3s ease;
        transform-origin: center;
      }
      .uploaded-image-number {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 1rem;
        color: #555;
      }
      .uploaded-image-name {
        margin-top: 5px;
        font-size: 1rem;
        color: #333;
        text-align: center;
        width: 100%;
      }
      .add-image-btn-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
      }
      .add-image-btn {
        border: none;
        background-color: #007bff;
        color: white;
        padding: 16px;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 10px;
      }
      .add-image-btn:hover {
        background-color: #0056b3;
      }
      .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loader-image {
        max-width: 150px;
        height: auto;
      }
      .image-actions {
        display: none;
        flex-direction: column;
        gap: 8px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 2;
      }
      .action-btn {
        background-color: rgba(0, 0, 0, 0.75);
        border: none;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        padding: 5px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .action-btn:hover {
        transform: scale(1.1);
      }
      .btn-label {
        font-size: 10px;
        margin-top: 2px;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        align-items: center;
        justify-content: center;
      }
      #previewContent {
        display: flex;
        align-items: center;
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 1000px;
        height: auto;
        max-height: 90%;
      }
      .preview-image-container {
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 800px;
        height: 600px;
        max-width: 100%;
        max-height: 100%;
      }
      .modal-preview-image {
        max-width: 100%;
        max-height: 100%;
        transition: transform 0.3s ease;
      }
      #previewButtons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-left: 40px;
      }
      .modal-btn {
        background-color: blue;
        color: white;
        border: none;
        padding: 20px 30px;
        border-radius: 5px;
        cursor: pointer;
        transition: opacity 0.2s ease;
        font-size: 1rem;
      }
      .modal-btn:hover {
        opacity: 0.8;
      }
      #modalZoomOut {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- Loader Overlay -->
    <div id="loader-overlay" class="loader-overlay">
      <img
        src="https://converter.app/jpeg-to-pdf/images/jpeg-to-pdf.png"
        alt="Loading..."
        class="loader-image"
      />
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
      <div class="logo">
        <img
          src="https://converter.app/jpeg-to-pdf/images/jpeg-to-pdf.png"
          alt="Logo"
        />
        <span class="logo-text">JPG to PDF Converter</span>
      </div>
    </div>

    <h2 class="page-heading">JPG to PDF</h2>

    <div class="buttons-container">
      <button id="convertBtn" style="display: none;" onclick="convertToPdf()">
        SAVE AS PDF
      </button>
      <button id="downloadBtn" style="display: none;" onclick="downloadPdf()">
        DOWNLOAD PDF
      </button>
    </div>

    <div class="upload-container" id="uploadContainer">
      <div class="inp-container">
        <input
          type="file"
          id="upload-file"
          onchange="handleFileUpload(event)"
          multiple
          accept="image/*"
        />
        <h4 class="drop">DRAG & DROP OR</h4>
        <p><i class="fa fa-file-image-o fa-4x img-icon"></i></p>
        <label for="upload-file" id="custom-file">CHOOSE FILES</label>
      </div>
    </div>

    <div class="description-container">
      <p>Select one or more JPG images to convert them into a single PDF.</p>
    </div>

    <div
      class="uploaded-images-container"
      id="uploadedImagesContainer"
      style="display: none;"
    ></div>

    <div
      id="addImageBtnContainer"
      class="add-image-btn-container"
      style="display: none;"
    >
      <button
        class="add-image-btn"
        onclick="document.getElementById('upload-file').click()"
      >
        Add More Image
      </button>
    </div>

    <!-- ðŸ”¹ Dynamic modal loader -->
    <script>
      async function loadPreviewModal() {
        try {
          const res = await fetch("preview.html");
          const html = await res.text();
          document.body.insertAdjacentHTML("beforeend", html);

          document
            .getElementById("modalClose")
            .addEventListener("click", closePreviewModal);
          document
            .getElementById("modalEdit")
            .addEventListener("click", () =>
              editImage(document.getElementById("previewModalImage").src)
            );
          document
            .getElementById("modalZoomIn")
            .addEventListener("click", zoomIn);
          document
            .getElementById("modalZoomOut")
            .addEventListener("click", zoomOut);
        } catch (err) {
          console.error("Error loading modal:", err);
        }
      }
      document.addEventListener("DOMContentLoaded", loadPreviewModal);
    </script>

    <!-- Main JS -->
    <script>
      let imageNumber = 0;
      let uploadedImages = [];
      let pdfBytes = null;
      let currentZoomLevel = 1;

      function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        const container = document.getElementById("uploadedImagesContainer");
        const upload = document.getElementById("uploadContainer");
        const desc = document.querySelector(".description-container");
        const addBtn = document.getElementById("addImageBtnContainer");

        upload.style.display = "none";
        desc.style.display = "none";
        container.style.display = "flex";
        addBtn.style.display = "flex";

        const promises = files.map((file, i) => {
          return new Promise((resolve) => {
            const r = new FileReader();
            r.onload = (e) => resolve({ file, dataURL: e.target.result, i });
            r.readAsDataURL(file);
          });
        });

        Promise.all(promises).then((res) => {
          res.sort((a, b) => a.i - b.i);
          res.forEach((r) => {
            imageNumber++;
            const wrap = document.createElement("div");
            wrap.classList.add("uploaded-image");
            wrap.setAttribute("data-id", imageNumber);

            const num = document.createElement("div");
            num.classList.add("uploaded-image-number");
            num.innerText = `#${imageNumber}`;

            const imgContainer = document.createElement("div");
            imgContainer.classList.add("image-container");

            const img = document.createElement("img");
            img.src = r.dataURL;
            img.setAttribute("data-rotation", "0");

            img.onload = function () {
              const style = window.getComputedStyle(img);
              img.dataset.origWidth = style.width;
              img.dataset.origHeight = style.height;
              imgContainer.style.width = style.width;
              imgContainer.style.height = style.height;
            };

            img.addEventListener("click", (e) => {
              e.stopPropagation();
              toggleActionButtons(img);
            });

            imgContainer.appendChild(img);
            const name = document.createElement("div");
            name.classList.add("uploaded-image-name");
            name.innerText = r.file.name;

            wrap.append(num, imgContainer, name);

            const actions = document.createElement("div");
            actions.classList.add("image-actions");

            const preview = document.createElement("button");
            preview.classList.add("action-btn");
            preview.innerHTML =
              '<i class="fa fa-eye"></i><span class="btn-label">Preview</span>';
            preview.onclick = (e) => {
              e.stopPropagation();
              previewImage(img);
            };

            const edit = document.createElement("button");
            edit.classList.add("action-btn");
            edit.innerHTML =
              '<i class="fa fa-pencil"></i><span class="btn-label">Edit</span>';
            edit.onclick = (e) => {
              e.stopPropagation();
              editImage(r.dataURL);
            };

            const rotate = document.createElement("button");
            rotate.classList.add("action-btn");
            rotate.innerHTML =
              '<i class="fa fa-rotate-right"></i><span class="btn-label">Rotate</span>';
            rotate.onclick = (e) => {
              e.stopPropagation();
              rotateImage(img);
            };

            const del = document.createElement("button");
            del.classList.add("action-btn");
            del.innerHTML =
              '<i class="fa fa-trash"></i><span class="btn-label">Delete</span>';
            del.onclick = (e) => {
              e.stopPropagation();
              deleteImage(wrap.getAttribute("data-id"));
            };

            actions.append(preview, edit, rotate, del);
            wrap.append(actions);
            container.appendChild(wrap);
            uploadedImages.push({ id: imageNumber, src: r.dataURL, element: wrap });
          });
          document.getElementById("convertBtn").style.display = "block";
        });
      }

      function toggleActionButtons(img) {
        document
          .querySelectorAll(".image-actions")
          .forEach((a) => (a.style.display = "none"));
        const wrap = img.closest(".uploaded-image");
        const actions = wrap.querySelector(".image-actions");
        actions.style.display =
          actions.style.display === "flex" ? "none" : "flex";
      }

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".uploaded-image")) {
          document
            .querySelectorAll(".image-actions")
            .forEach((a) => (a.style.display = "none"));
        }
      });

      function editImage(d) {
        window.location.href = "edit.html?img=" + encodeURIComponent(d);
      }

      async function convertToPdf() {
        const { PDFDocument, degrees } = PDFLib;
        if (uploadedImages.length === 0) return alert("Upload images first!");
        document.getElementById("loader-overlay").style.display = "flex";
        try {
          const pdf = await PDFDocument.create();
          for (const img of uploadedImages) {
            const res = await fetch(img.src);
            const bytes = await res.arrayBuffer();
            const mime = img.src.match(/^data:(image\/[a-zA-Z]+);base64,/);
            const embed =
              mime && mime[1] === "image/png"
                ? await pdf.embedPng(bytes)
                : await pdf.embedJpg(bytes);
            const el = img.element.querySelector("img");
            const rot = parseInt(el.getAttribute("data-rotation") || "0");
            let page, w = embed.width, h = embed.height;
            switch (rot) {
              case 90:
                page = pdf.addPage([h, w]);
                page.drawImage(embed, { x: 0, y: w, width: w, height: h, rotate: degrees(270) });
                break;
              case 180:
                page = pdf.addPage([w, h]);
                page.drawImage(embed, { x: w, y: h, width: w, height: h, rotate: degrees(180) });
                break;
              case 270:
                page = pdf.addPage([h, w]);
                page.drawImage(embed, { x: h, y: 0, width: w, height: h, rotate: degrees(90) });
                break;
              default:
                page = pdf.addPage([w, h]);
                page.drawImage(embed, { x: 0, y: 0, width: w, height: h });
            }
          }
          pdfBytes = await pdf.save();
          document.getElementById("downloadBtn").style.display = "block";
        } catch (e) {
          console.error(e);
          alert("Error creating PDF.");
        } finally {
          document.getElementById("loader-overlay").style.display = "none";
        }
      }

      function downloadPdf() {
        if (pdfBytes) download(pdfBytes, "images.pdf", "application/pdf");
      }

      function rotateImage(img) {
        let r = parseInt(img.getAttribute("data-rotation") || "0");
        r = (r + 90) % 360;
        img.style.transform = "rotate(" + r + "deg)";
        img.setAttribute("data-rotation", r);
      }

      function deleteImage(id) {
        const i = uploadedImages.findIndex((x) => x.id == id);
        if (i !== -1) {
          uploadedImages[i].element.remove();
          uploadedImages.splice(i, 1);
        }
      }

      function previewImage(img) {
        const modal = document.getElementById("previewModal");
        const modalImg = document.getElementById("previewModalImage");
        modalImg.src = img.src;
        currentZoomLevel = 1;
        modalImg.style.transform = "scale(1)";
        modal.style.display = "flex";
      }

      function closePreviewModal() {
        document.getElementById("previewModal").style.display = "none";
      }

      function zoomIn() {
        if (currentZoomLevel < 3) {
          currentZoomLevel += 0.2;
          document.getElementById("previewModalImage").style.transform =
            "scale(" + currentZoomLevel + ")";
        }
        if (currentZoomLevel > 1)
          document.getElementById("modalZoomOut").style.display = "block";
      }

      function zoomOut() {
        if (currentZoomLevel > 1) {
          currentZoomLevel -= 0.2;
          if (currentZoomLevel < 1) currentZoomLevel = 1;
          document.getElementById("previewModalImage").style.transform =
            "scale(" + currentZoomLevel + ")";
        }
        if (currentZoomLevel === 1)
          document.getElementById("modalZoomOut").style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", () => {
        Sortable.create(document.getElementById("uploadedImagesContainer"), {
          animation: 150,
        });
      });
    </script>
  </body>
</html>
